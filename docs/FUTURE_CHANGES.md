# Future Changes & Feature Requests

**Created:** December 2025  
**Purpose:** Track planned changes, feature requests, and improvements to the Alano Club membership management system.

---

## Format Guide

Each change entry includes:
- **Status**: Planned / In Progress / Completed / Cancelled
- **Priority**: High / Medium / Low
- **Estimated Effort**: Time estimate
- **Description**: What needs to be changed
- **Implementation Steps**: Step-by-step breakdown
- **Dependencies**: What needs to be done first
- **Testing Requirements**: How to verify the change works

---

## Change Log

### Change #001: Enhanced Override Expiration Date Selection

**Status:** ✅ Completed  
**Priority:** Medium  
**Estimated Effort:** 2-3 hours  
**Created:** December 2025  
**Completed:** December 2025

#### Description

Currently, the payment confirmation page uses a single dropdown that shows dates generated by JavaScript, limited to 6 months forward from the calculated expiration date. This change will replace it with two separate dropdowns:
- **Month dropdown**: January through December (in order)
- **Year dropdown**: Current year through 3-4 years in the future

This provides more flexibility and a clearer user interface for selecting override expiration dates.

#### Current Implementation

**Location:** `members/templates/members/add_payment.html` (confirmation step)

**Current Behavior:**
- Single `<select>` dropdown (`override-expiration-select`)
- JavaScript generates options starting from calculated expiration date
- Limited to 6 months forward
- Options show full date format: "January 31, 2025"

**Current Code:**
```javascript
// Lines 535-569 in add_payment.html
for (let i = 0; i <= 6; i++) {
    // Creates options for calculated date + 0-6 months
    // Format: "January 31, 2025"
}
```

#### Proposed Implementation

**New UI Structure:**
```html
<div class="row g-2">
    <div class="col-6">
        <select class="form-select" id="override-month-select" name="override_month">
            <option value="1">January</option>
            <option value="2">February</option>
            <!-- ... all 12 months ... -->
            <option value="12">December</option>
        </select>
    </div>
    <div class="col-6">
        <select class="form-select" id="override-year-select" name="override_year">
            <option value="2025">2025</option>
            <option value="2026">2026</option>
            <!-- ... current year through 3-4 years forward ... -->
        </select>
    </div>
</div>
<small class="form-text text-muted">
    All dates are automatically set to the last day of the selected month
</small>
<input type="hidden" id="override-expiration-hidden" name="override_expiration">
```

#### Implementation Steps

**Step 1: Update Template (`members/templates/members/add_payment.html`)**

1. **Replace the single dropdown** (around line 332-336):
   - Remove: `<select id="override-expiration-select">`
   - Add: Two separate dropdowns for month and year
   - Add: Hidden input field to store the calculated date

2. **Update JavaScript** (around lines 535-589):
   - Remove: The 6-month loop that generates date options
   - Add: Function to populate month dropdown (all 12 months)
   - Add: Function to populate year dropdown (current year + 3-4 years)
   - Add: Function to calculate end-of-month date when month/year changes
   - Add: Function to update hidden field with calculated date
   - Set default values to match calculated expiration date's month/year

**Step 2: Update View (`members/views/payments.py`)**

**Location:** `add_payment_view()` - "confirm" step (around line 118-138)

**Current:**
```python
override_expiration = request.POST.get("override_expiration")
if override_expiration:
    override_expiration_date = datetime.strptime(
        override_expiration, "%Y-%m-%d"
    ).date()
```

**Change to:**
```python
# Support both old format (override_expiration) and new format (override_month/year)
override_expiration = request.POST.get("override_expiration")
override_month = request.POST.get("override_month")
override_year = request.POST.get("override_year")

# If new format is provided, construct date
if override_month and override_year:
    from ..utils import ensure_end_of_month
    override_expiration_date = ensure_end_of_month(
        date(int(override_year), int(override_month), 1)
    )
elif override_expiration:
    # Legacy support for old format
    override_expiration_date = datetime.strptime(
        override_expiration, "%Y-%m-%d"
    ).date()
else:
    override_expiration_date = None
```

**Also update:** "process" step (around line 197-208) to handle the new format

**Step 3: Update Hidden Fields**

**Location:** `members/templates/members/add_payment.html` (confirmation forms)

Ensure hidden fields (`override-expiration-hidden-mobile` and `override-expiration-hidden-desktop`) are populated from the month/year dropdowns via JavaScript before form submission.

#### Dependencies

- ✅ Step 5 (Split Views) - Completed
- ✅ PaymentService exists - Completed
- ✅ `ensure_end_of_month` utility exists - Completed

#### Testing Requirements

1. **Manual Testing:**
   - Navigate to payment confirmation page
   - Verify month dropdown shows all 12 months in order
   - Verify year dropdown shows current year through 3-4 years forward
   - Verify default selection matches calculated expiration date
   - Select different month/year combinations
   - Submit payment and verify expiration date is set correctly
   - Verify date is always set to last day of selected month

2. **Edge Cases:**
   - Test with leap year (February 29)
   - Test with different member types
   - Test with different payment amounts
   - Verify backward compatibility (if old format still exists)

3. **Automated Testing:**
   - Add test cases to `tests/test_payment_service.py` for month/year override
   - Add integration test for payment flow with override

#### Benefits

- ✅ More flexible date selection (up to 4 years vs 6 months)
- ✅ Clearer UI (separate month/year vs single date dropdown)
- ✅ Better user experience
- ✅ Consistent with common date selection patterns

#### Implementation Summary

**Completed Steps:**
1. ✅ Updated template HTML - Replaced single dropdown with month/year dropdowns
2. ✅ Updated JavaScript - Implemented month/year selection with end-of-month calculation
3. ✅ Updated view code - Added safety checks for end-of-month dates
4. ✅ Added comprehensive tests - Unit tests and integration tests

**Key Changes:**
- `members/templates/members/add_payment.html`: Month/year dropdowns with JavaScript date calculation
- `members/views/payments.py`: Enhanced override expiration handling with `ensure_end_of_month` safety checks
- `tests/test_payment_service.py`: Added 3 new tests for override expiration functionality
- `tests/test_views.py`: Added integration test for full payment flow with override

**Features Implemented:**
- Month dropdown: All 12 months (January-December)
- Year dropdown: Current year through 4 years forward
- Automatic end-of-month calculation
- Validation prevents selecting dates in the past (allows current month)
- Default selection matches calculated expiration date
- Server-side safety check ensures end-of-month dates

**Testing:**
- ✅ All 14 payment service tests passing (including 3 new override tests)
- ✅ Integration test for full payment flow with override
- ✅ Manual testing confirmed by user
- ✅ Edge cases tested (leap years, all months, year boundaries)

#### Notes

- Backward compatibility maintained: View still accepts `override_expiration` date string format
- Validation implemented: Prevents selecting dates in the past (allows current month)
- Server-side safety: `ensure_end_of_month` utility ensures dates are always end-of-month
- **Enhancement:** Month dropdown displays last day explicitly (e.g., "April (30th)", "February (28th/29th)") for clarity

#### Completion Summary

**Files Modified:**
- `members/templates/members/add_payment.html`: Updated HTML structure and JavaScript
- `members/views/payments.py`: Enhanced override expiration handling
- `tests/test_payment_service.py`: Added 3 new unit tests
- `tests/test_views.py`: Added 1 integration test

**Key Features Delivered:**
- ✅ Month dropdown with all 12 months (January-December)
- ✅ Year dropdown with current year through 4 years forward
- ✅ Automatic end-of-month date calculation
- ✅ Client-side validation prevents past dates
- ✅ Server-side safety check ensures end-of-month dates
- ✅ Default selection matches calculated expiration date
- ✅ Comprehensive test coverage (unit + integration)

**Test Results:**
- ✅ All 14 payment service tests passing
- ✅ Integration test for full payment flow passing
- ✅ Manual testing confirmed working
- ✅ Edge cases verified (leap years, all months)

---

### Change #002: Duplicate Member Detection During Creation

**Status:** ✅ Completed  
**Priority:** High  
**Estimated Effort:** 1-2 hours  
**Created:** December 2025  
**Completed:** November 29, 2025 at 07:03 PM

#### Description

Add duplicate member detection during the member creation workflow to prevent creating new members when existing members (especially inactive ones) already exist with matching identifying information. This helps prevent duplicate entries and encourages reactivating existing inactive members instead.

#### Current Implementation

**Location:** `members/views/members.py` - `add_member_view()` "confirm" step

**Current Behavior:**
- Form validation checks for required fields
- Validates member ID availability
- No duplicate checking for name, phone, or email
- Proceeds directly to member creation

#### Proposed Implementation

**New Functionality:**
- Check for existing members matching:
  1. **First name + Last name combination** (case-insensitive)
  2. **Phone number** (if provided)
  3. **Email address** (if provided)
- Display warning on confirmation page if matches found
- Show matching member(s) with match reason and link to view member
- Suggest reactivating existing member instead of creating duplicate

#### Implementation Steps

**Step 1: Add Service Method (`members/services.py`)**

Add `check_duplicate_members()` method to `MemberService` class:

```python
@staticmethod
def check_duplicate_members(first_name, last_name, email, phone):
    """
    Check for existing members matching name, phone, or email.
    
    Args:
        first_name: First name to check
        last_name: Last name to check
        email: Email to check (can be empty)
        phone: Phone number to check (can be empty, database field is home_phone)
    
    Returns:
        List of dicts with keys: 'member', 'match_reason', 'match_text'
    """
    matches = []
    
    # Check name combination (case-insensitive)
    name_matches = Member.objects.filter(
        first_name__iexact=first_name,
        last_name__iexact=last_name
    )
    for member in name_matches:
        matches.append({
            'member': member,
            'match_reason': 'name',
            'match_text': f'{first_name} {last_name}'
        })
    
    # Check phone (if provided) - database field is home_phone
    if phone:
        phone_matches = Member.objects.filter(home_phone=phone)
        for member in phone_matches:
            # Avoid duplicates if already matched by name
            if not any(m['member'].pk == member.pk for m in matches):
                matches.append({
                    'member': member,
                    'match_reason': 'phone',
                    'match_text': phone
                })
    
    # Check email (if provided)
    if email:
        email_matches = Member.objects.filter(email__iexact=email)
        for member in email_matches:
            # Avoid duplicates if already matched by name/phone
            if not any(m['member'].pk == member.pk for m in matches):
                matches.append({
                    'member': member,
                    'match_reason': 'email',
                    'match_text': email
                })
    
    return matches
```

**Step 2: Update View (`members/views/members.py`)**

**Location:** `add_member_view()` - "confirm" step (after validation, around line 126)

**Add duplicate check:**
```python
# After validation, before storing in session
# Check for duplicate members
duplicate_members = MemberService.check_duplicate_members(
    first_name, last_name, email, home_phone
)

# Add to context
context = {
    "step": "confirm",
    # ... existing context ...
    "duplicate_members": duplicate_members,  # Add this
}
```

**Step 3: Update Template (`members/templates/members/add_member.html`)**

**Location:** Confirmation step section

**Add warning banner if duplicates found:**
```html
{% if duplicate_members %}
<div class="alert alert-warning" role="alert">
    <h5><i class="bi bi-exclamation-triangle me-2"></i>Potential Duplicate Member Found</h5>
    <p>The following existing member(s) match the information provided:</p>
    <ul>
        {% for match in duplicate_members %}
        <li>
            <strong>{{ match.member.full_name }}</strong> 
            ({{ match.member.member_id|default:"No ID" }}) - 
            Status: {{ match.member.status|title }}
            <br>
            <small class="text-muted">
                Matched by: {{ match.match_reason|title }} 
                ({{ match.match_text }})
            </small>
            <br>
            <a href="{% url 'members:member_detail' match.member.member_uuid %}" 
               class="btn btn-sm btn-outline-primary mt-1" 
               target="_blank">
                View Member
            </a>
        </li>
        {% endfor %}
    </ul>
    <p class="mb-0">
        <strong>Consider reactivating this member instead of creating a new one.</strong>
    </p>
</div>
{% endif %}
```

#### Dependencies

- ✅ Step 5 (Split Views) - Completed
- ✅ MemberService exists - Completed
- ✅ Member model has required fields (first_name, last_name, email, home_phone) - Completed

#### Testing Requirements

1. **Manual Testing:**
   - Create member with name matching existing inactive member
   - Create member with phone matching existing member
   - Create member with email matching existing member
   - Create member with multiple matches (name + phone)
   - Verify warning displays correctly
   - Verify link to existing member works
   - Verify member creation still works (warning doesn't block)

2. **Edge Cases:**
   - Empty phone/email fields
   - Case sensitivity (name matching)
   - Multiple matches for same member (name + phone + email)
   - Active vs inactive members

3. **Automated Testing:**
   - Add test cases to `tests/test_member_service.py` for `check_duplicate_members()`
   - Test name matching (case-insensitive)
   - Test phone matching
   - Test email matching
   - Test combination matches
   - Test empty fields

#### Benefits

- ✅ Prevents duplicate member creation
- ✅ Helps identify inactive members for reactivation
- ✅ Improves data quality
- ✅ Reduces manual cleanup needed
- ✅ Better user experience (suggests reactivation)

#### Implementation Summary

**Completed Steps:**
1. ✅ Added `check_duplicate_members()` static method to `MemberService` class
2. ✅ Updated `add_member_view()` to call duplicate check in "confirm" step
3. ✅ Updated `add_member.html` template to display warning banner when duplicates found
4. ✅ Added comprehensive test suite (9 test cases, all passing)

**Key Changes:**
- `members/services.py`: Added `check_duplicate_members()` method with name, phone, and email matching
- `members/views/members.py`: Added duplicate check call and included results in context
- `members/templates/members/add_member.html`: Added warning banner with matching member details and links
- `tests/test_member_service.py`: Added `TestMemberServiceCheckDuplicateMembers` class with 9 test methods

**Features Implemented:**
- Name matching: Case-insensitive first + last name combination
- Phone matching: Exact match on `home_phone` field (if provided)
- Email matching: Case-insensitive email matching (if provided)
- Duplicate prevention: Avoids duplicate entries in results (checks by `member.pk`)
- Warning display: Shows matching members with full details, status, and view links
- All statuses: Checks active, inactive, and deceased members
- Non-blocking: Warning only, does not prevent member creation

**Testing:**
- ✅ All 9 unit tests passing
- ✅ Manual testing confirmed by user
- ✅ Edge cases tested (empty fields, multiple matches, case sensitivity, all statuses)

#### Notes

- Warning only - does not block member creation (allows override)
- Checks all member statuses (active, inactive, deceased)
- Case-insensitive matching for names and emails
- Phone matching is exact (database field is `home_phone`)
- Future enhancement: Add "Reactivate Instead" button that redirects to reactivation flow

---

### Change #003: New Member Creation with Initial Payment

**Status:** Planned  
**Priority:** High  
**Estimated Effort:** 4-6 hours  
**Created:** November 29, 2025

#### Description

Currently, when creating a new member, the system automatically calculates and displays an expiration date on the confirmation page before the member has made any payment. This change will modify the workflow so that:

1. New members must provide an initial payment before their membership expiration date is set
2. The confirmation page will not show an expiration date (since no payment has been made yet)
3. After confirmation, users will proceed to a payment form to collect the initial payment
4. The expiration date will be calculated from today's date based on the payment amount
5. Member and payment will be created together in a single atomic operation

This ensures that every new member has an accompanying initial payment and that expiration dates are based on actual payments rather than assumptions.

#### Current Implementation

**Location:** `members/views/members.py` - `add_member_view()`

**Current Workflow:**
1. **Form step**: User enters member information
2. **Confirm step**: 
   - Shows member information
   - Calculates and displays expiration date automatically (end of current month + member type months)
   - Shows "Create Member" button
   - Displays "Membership & Contact" card with expiration date
3. **Process step**: Creates member immediately with calculated expiration date

**Current Behavior:**
- Expiration date is calculated before any payment is received
- Member is created without an initial payment record
- No payment collection step in member creation workflow

**Current Code:**
```python
# Lines 127-132 in members/views/members.py
# Calculate initial expiration date (end of current month + member type months)
today = date.today()
current_month_end = ensure_end_of_month(today)
initial_expiration = add_months_to_date(
    current_month_end, member_type.num_months
)
```

#### Proposed Implementation

**New Workflow:**
1. **Form step**: User enters member information (unchanged)
2. **Confirm step**: 
   - Shows member information (Name, Member ID, Member Type, Email, Milestone Date, Date Joined)
   - Shows contact information (Address, Phone, Email if provided)
   - **NO expiration date displayed** (member hasn't paid yet)
   - Shows "Proceed to Payment" button (instead of "Create Member")
   - Duplicate member detection still runs (as implemented in Change #002)
3. **Payment step** (NEW): 
   - Collect payment information (amount, payment date, payment method, receipt number)
   - Calculate expiration date from today's date based on payment amount
   - Payment covers remainder of current month + next month(s) to reach end-of-month date
   - Similar to existing payment form but adapted for new members
4. **Process step**: 
   - Calculate expiration date from payment amount (starting from today)
   - Create member with calculated expiration date
   - Create payment record linked to new member
   - Both operations happen atomically

**Key Changes:**
- Remove expiration date calculation from confirm step
- Split confirmation page into "Member Information" and "Contact" cards (remove "Membership & Contact")
- Add new "payment" step to `add_member_view()`
- Add new method to `PaymentService` for calculating expiration for new members (from today, not existing expiration)
- Modify process step to create member first, then payment (required by database ForeignKey constraint)

#### Implementation Steps

**Step 1: Add New Method to PaymentService (`members/services.py`)**

Add method to calculate expiration for new members (starts from today, not existing member expiration):

```python
@staticmethod
def calculate_expiration_for_new_member(member_type, payment_amount, start_date=None, override_expiration=None):
    """
    Calculate expiration date for a new member (starts from today, not existing expiration).
    
    Args:
        member_type: MemberType instance
        payment_amount: Decimal payment amount
        start_date: Starting date for calculation (defaults to today)
        override_expiration: Optional date to override calculation
    
    Returns:
        date: New expiration date (end of month)
    """
    if override_expiration:
        return ensure_end_of_month(override_expiration)
    
    if start_date is None:
        start_date = date.today()
    
    # Ensure start_date is end of month
    start_date = ensure_end_of_month(start_date)
    
    if member_type and member_type.member_dues > 0:
        months_paid = float(payment_amount) / float(member_type.member_dues)
        total_months_to_add = int(months_paid)
        return add_months_to_date(start_date, total_months_to_add)
    else:
        return add_months_to_date(start_date, 1)
```

**Step 2: Update add_member_view() - Remove Expiration from Confirm Step**

**Location:** `members/views/members.py` - "confirm" step (around lines 127-132)

**Changes:**
- Remove expiration date calculation from confirm step
- Remove `initial_expiration` from context
- Keep duplicate member check (already implemented)

**Step 3: Update add_member_view() - Add Payment Step**

**Location:** `members/views/members.py` - Add new `elif step == "payment"` handler

**New Step Flow:**
- Validate member_data exists in session
- Get payment form data (amount, payment_date, payment_method, receipt_number)
- Validate payment data
- Calculate expiration date using `PaymentService.calculate_expiration_for_new_member()`
- Store payment_data in session
- Render payment confirmation page

**Step 4: Update add_member_view() - Modify Process Step**

**Location:** `members/views/members.py` - "process" step (around lines 182-211)

**Changes:**
- Get both `member_data` and `payment_data` from session
- Calculate expiration date from payment (using new method)
- Create member with calculated expiration date
- Create payment record linked to new member
- Clear both session data entries
- Redirect to member detail page or search page

**Step 5: Update Template - Modify Confirmation Page**

**Location:** `members/templates/members/add_member.html` - Confirmation step (around lines 226-321)

**Changes:**
- Remove "Initial Expiration" field from display
- Split "Membership & Contact" card into:
  - "Member Information" card (left): Name, Member ID, Member Type, Email, Milestone Date, Date Joined
  - "Contact" card (right): Address, Phone, Email (if provided)
- Change button from "Create Member" to "Proceed to Payment"
- Update button action to go to `?step=payment`

**Step 6: Update Template - Add Payment Form Page**

**Location:** `members/templates/members/add_member.html` - Add new payment step section

**New Template Section:**
- Payment form similar to existing payment form
- Fields: Amount, Payment Date, Payment Method, Receipt Number
- Show calculated expiration date preview (based on payment amount)
- JavaScript to calculate expiration date dynamically
- "Back to Review" and "Confirm Payment" buttons

**Step 7: Update MemberService.create_member() (if needed)**

**Location:** `members/services.py` - `create_member()` method

**Check if modification needed:**
- Ensure method accepts expiration_date from payment calculation
- May need to modify to not calculate expiration internally

#### Dependencies

- ✅ Change #002 (Duplicate Member Detection) - Completed
- ✅ PaymentService exists - Completed
- ✅ MemberService.create_member() exists - Completed
- ✅ Payment model has ForeignKey to Member - Completed
- ✅ PaymentService.process_payment() exists - Completed

#### Testing Requirements

1. **Manual Testing:**
   - Create new member and verify no expiration date on confirmation page
   - Verify "Proceed to Payment" button appears instead of "Create Member"
   - Complete payment flow for new member
   - Verify expiration date is calculated from today's date
   - Verify member and payment are both created successfully
   - Verify expiration date matches payment amount calculation
   - Test with different payment amounts
   - Test with different member types
   - Verify duplicate detection still works on confirmation page

2. **Edge Cases:**
   - Payment amount less than monthly dues (partial month)
   - Payment amount covering multiple months
   - Payment on last day of month
   - Payment at month boundaries
   - Empty payment fields
   - Invalid payment data
   - Session expiration during payment step

3. **Automated Testing:**
   - Add test cases to `tests/test_payment_service.py` for `calculate_expiration_for_new_member()`
   - Test expiration calculation from today's date
   - Test with different payment amounts
   - Test with different member types
   - Add integration test for full new member + payment workflow
   - Test atomicity (member and payment created together)

#### Benefits

- ✅ Ensures every new member has an initial payment record
- ✅ Expiration dates are based on actual payments, not assumptions
- ✅ More accurate membership tracking
- ✅ Better audit trail (payment history starts from member creation)
- ✅ Consistent workflow (all members have payment records)
- ✅ Prevents creating members without payments

#### Notes

- **Database Constraint**: Payment model has ForeignKey to Member, so member MUST be created before payment. This is why we create member first, then payment in the process step.
- **Expiration Calculation**: For new members, expiration is calculated from today's date (end of current month) forward, not from an existing member's expiration date.
- **Session Management**: Both `member_data` and `payment_data` are stored in session and cleared together after successful creation.
- **Atomic Operation**: Member and payment creation should happen together - if payment creation fails, member creation should be rolled back (consider using database transactions).
- **Payment Form**: The payment form for new members will be similar to existing payment form but won't have "current expiration" since member doesn't exist yet.
- **Future Enhancement**: Consider adding ability to edit payment before final confirmation.

---

## Template for New Changes

### Change #XXX: [Title]

**Status:** Planned  
**Priority:** [High/Medium/Low]  
**Estimated Effort:** [Time estimate]  
**Created:** [Date]

#### Description
[What needs to be changed and why]

#### Current Implementation
[How it currently works]

#### Proposed Implementation
[How it should work]

#### Implementation Steps
1. Step 1: [Description]
2. Step 2: [Description]
3. Step 3: [Description]

#### Dependencies
- [What needs to be completed first]

#### Testing Requirements
- [How to verify it works]

#### Benefits
- [Why this change is valuable]

#### Notes
[Any additional considerations]

---

