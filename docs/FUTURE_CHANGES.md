# Future Changes & Feature Requests

**Created:** December 2025  
**Purpose:** Track planned changes, feature requests, and improvements to the Alano Club membership management system.

---

## Format Guide

Each change entry includes:
- **Status**: Planned / In Progress / Completed / Cancelled
- **Priority**: High / Medium / Low
- **Estimated Effort**: Time estimate
- **Description**: What needs to be changed
- **Implementation Steps**: Step-by-step breakdown
- **Dependencies**: What needs to be done first
- **Testing Requirements**: How to verify the change works

---

## Change Log

### Change #001: Enhanced Override Expiration Date Selection

**Status:** ✅ Completed  
**Priority:** Medium  
**Estimated Effort:** 2-3 hours  
**Created:** December 2025  
**Completed:** December 2025

#### Description

Currently, the payment confirmation page uses a single dropdown that shows dates generated by JavaScript, limited to 6 months forward from the calculated expiration date. This change will replace it with two separate dropdowns:
- **Month dropdown**: January through December (in order)
- **Year dropdown**: Current year through 3-4 years in the future

This provides more flexibility and a clearer user interface for selecting override expiration dates.

#### Current Implementation

**Location:** `members/templates/members/add_payment.html` (confirmation step)

**Current Behavior:**
- Single `<select>` dropdown (`override-expiration-select`)
- JavaScript generates options starting from calculated expiration date
- Limited to 6 months forward
- Options show full date format: "January 31, 2025"

**Current Code:**
```javascript
// Lines 535-569 in add_payment.html
for (let i = 0; i <= 6; i++) {
    // Creates options for calculated date + 0-6 months
    // Format: "January 31, 2025"
}
```

#### Proposed Implementation

**New UI Structure:**
```html
<div class="row g-2">
    <div class="col-6">
        <select class="form-select" id="override-month-select" name="override_month">
            <option value="1">January</option>
            <option value="2">February</option>
            <!-- ... all 12 months ... -->
            <option value="12">December</option>
        </select>
    </div>
    <div class="col-6">
        <select class="form-select" id="override-year-select" name="override_year">
            <option value="2025">2025</option>
            <option value="2026">2026</option>
            <!-- ... current year through 3-4 years forward ... -->
        </select>
    </div>
</div>
<small class="form-text text-muted">
    All dates are automatically set to the last day of the selected month
</small>
<input type="hidden" id="override-expiration-hidden" name="override_expiration">
```

#### Implementation Steps

**Step 1: Update Template (`members/templates/members/add_payment.html`)**

1. **Replace the single dropdown** (around line 332-336):
   - Remove: `<select id="override-expiration-select">`
   - Add: Two separate dropdowns for month and year
   - Add: Hidden input field to store the calculated date

2. **Update JavaScript** (around lines 535-589):
   - Remove: The 6-month loop that generates date options
   - Add: Function to populate month dropdown (all 12 months)
   - Add: Function to populate year dropdown (current year + 3-4 years)
   - Add: Function to calculate end-of-month date when month/year changes
   - Add: Function to update hidden field with calculated date
   - Set default values to match calculated expiration date's month/year

**Step 2: Update View (`members/views/payments.py`)**

**Location:** `add_payment_view()` - "confirm" step (around line 118-138)

**Current:**
```python
override_expiration = request.POST.get("override_expiration")
if override_expiration:
    override_expiration_date = datetime.strptime(
        override_expiration, "%Y-%m-%d"
    ).date()
```

**Change to:**
```python
# Support both old format (override_expiration) and new format (override_month/year)
override_expiration = request.POST.get("override_expiration")
override_month = request.POST.get("override_month")
override_year = request.POST.get("override_year")

# If new format is provided, construct date
if override_month and override_year:
    from ..utils import ensure_end_of_month
    override_expiration_date = ensure_end_of_month(
        date(int(override_year), int(override_month), 1)
    )
elif override_expiration:
    # Legacy support for old format
    override_expiration_date = datetime.strptime(
        override_expiration, "%Y-%m-%d"
    ).date()
else:
    override_expiration_date = None
```

**Also update:** "process" step (around line 197-208) to handle the new format

**Step 3: Update Hidden Fields**

**Location:** `members/templates/members/add_payment.html` (confirmation forms)

Ensure hidden fields (`override-expiration-hidden-mobile` and `override-expiration-hidden-desktop`) are populated from the month/year dropdowns via JavaScript before form submission.

#### Dependencies

- ✅ Step 5 (Split Views) - Completed
- ✅ PaymentService exists - Completed
- ✅ `ensure_end_of_month` utility exists - Completed

#### Testing Requirements

1. **Manual Testing:**
   - Navigate to payment confirmation page
   - Verify month dropdown shows all 12 months in order
   - Verify year dropdown shows current year through 3-4 years forward
   - Verify default selection matches calculated expiration date
   - Select different month/year combinations
   - Submit payment and verify expiration date is set correctly
   - Verify date is always set to last day of selected month

2. **Edge Cases:**
   - Test with leap year (February 29)
   - Test with different member types
   - Test with different payment amounts
   - Verify backward compatibility (if old format still exists)

3. **Automated Testing:**
   - Add test cases to `tests/test_payment_service.py` for month/year override
   - Add integration test for payment flow with override

#### Benefits

- ✅ More flexible date selection (up to 4 years vs 6 months)
- ✅ Clearer UI (separate month/year vs single date dropdown)
- ✅ Better user experience
- ✅ Consistent with common date selection patterns

#### Implementation Summary

**Completed Steps:**
1. ✅ Updated template HTML - Replaced single dropdown with month/year dropdowns
2. ✅ Updated JavaScript - Implemented month/year selection with end-of-month calculation
3. ✅ Updated view code - Added safety checks for end-of-month dates
4. ✅ Added comprehensive tests - Unit tests and integration tests

**Key Changes:**
- `members/templates/members/add_payment.html`: Month/year dropdowns with JavaScript date calculation
- `members/views/payments.py`: Enhanced override expiration handling with `ensure_end_of_month` safety checks
- `tests/test_payment_service.py`: Added 3 new tests for override expiration functionality
- `tests/test_views.py`: Added integration test for full payment flow with override

**Features Implemented:**
- Month dropdown: All 12 months (January-December)
- Year dropdown: Current year through 4 years forward
- Automatic end-of-month calculation
- Validation prevents selecting dates in the past (allows current month)
- Default selection matches calculated expiration date
- Server-side safety check ensures end-of-month dates

**Testing:**
- ✅ All 14 payment service tests passing (including 3 new override tests)
- ✅ Integration test for full payment flow with override
- ✅ Manual testing confirmed by user
- ✅ Edge cases tested (leap years, all months, year boundaries)

#### Notes

- Backward compatibility maintained: View still accepts `override_expiration` date string format
- Validation implemented: Prevents selecting dates in the past (allows current month)
- Server-side safety: `ensure_end_of_month` utility ensures dates are always end-of-month
- **Enhancement:** Month dropdown displays last day explicitly (e.g., "April (30th)", "February (28th/29th)") for clarity

#### Completion Summary

**Files Modified:**
- `members/templates/members/add_payment.html`: Updated HTML structure and JavaScript
- `members/views/payments.py`: Enhanced override expiration handling
- `tests/test_payment_service.py`: Added 3 new unit tests
- `tests/test_views.py`: Added 1 integration test

**Key Features Delivered:**
- ✅ Month dropdown with all 12 months (January-December)
- ✅ Year dropdown with current year through 4 years forward
- ✅ Automatic end-of-month date calculation
- ✅ Client-side validation prevents past dates
- ✅ Server-side safety check ensures end-of-month dates
- ✅ Default selection matches calculated expiration date
- ✅ Comprehensive test coverage (unit + integration)

**Test Results:**
- ✅ All 14 payment service tests passing
- ✅ Integration test for full payment flow passing
- ✅ Manual testing confirmed working
- ✅ Edge cases verified (leap years, all months)

---

### Change #002: Duplicate Member Detection During Creation

**Status:** ✅ Completed  
**Priority:** High  
**Estimated Effort:** 1-2 hours  
**Created:** December 2025  
**Completed:** November 29, 2025 at 07:03 PM

#### Description

Add duplicate member detection during the member creation workflow to prevent creating new members when existing members (especially inactive ones) already exist with matching identifying information. This helps prevent duplicate entries and encourages reactivating existing inactive members instead.

#### Current Implementation

**Location:** `members/views/members.py` - `add_member_view()` "confirm" step

**Current Behavior:**
- Form validation checks for required fields
- Validates member ID availability
- No duplicate checking for name, phone, or email
- Proceeds directly to member creation

#### Proposed Implementation

**New Functionality:**
- Check for existing members matching:
  1. **First name + Last name combination** (case-insensitive)
  2. **Phone number** (if provided)
  3. **Email address** (if provided)
- Display warning on confirmation page if matches found
- Show matching member(s) with match reason and link to view member
- Suggest reactivating existing member instead of creating duplicate

#### Implementation Steps

**Step 1: Add Service Method (`members/services.py`)**

Add `check_duplicate_members()` method to `MemberService` class:

```python
@staticmethod
def check_duplicate_members(first_name, last_name, email, phone):
    """
    Check for existing members matching name, phone, or email.
    
    Args:
        first_name: First name to check
        last_name: Last name to check
        email: Email to check (can be empty)
        phone: Phone number to check (can be empty, database field is home_phone)
    
    Returns:
        List of dicts with keys: 'member', 'match_reason', 'match_text'
    """
    matches = []
    
    # Check name combination (case-insensitive)
    name_matches = Member.objects.filter(
        first_name__iexact=first_name,
        last_name__iexact=last_name
    )
    for member in name_matches:
        matches.append({
            'member': member,
            'match_reason': 'name',
            'match_text': f'{first_name} {last_name}'
        })
    
    # Check phone (if provided) - database field is home_phone
    if phone:
        phone_matches = Member.objects.filter(home_phone=phone)
        for member in phone_matches:
            # Avoid duplicates if already matched by name
            if not any(m['member'].pk == member.pk for m in matches):
                matches.append({
                    'member': member,
                    'match_reason': 'phone',
                    'match_text': phone
                })
    
    # Check email (if provided)
    if email:
        email_matches = Member.objects.filter(email__iexact=email)
        for member in email_matches:
            # Avoid duplicates if already matched by name/phone
            if not any(m['member'].pk == member.pk for m in matches):
                matches.append({
                    'member': member,
                    'match_reason': 'email',
                    'match_text': email
                })
    
    return matches
```

**Step 2: Update View (`members/views/members.py`)**

**Location:** `add_member_view()` - "confirm" step (after validation, around line 126)

**Add duplicate check:**
```python
# After validation, before storing in session
# Check for duplicate members
duplicate_members = MemberService.check_duplicate_members(
    first_name, last_name, email, home_phone
)

# Add to context
context = {
    "step": "confirm",
    # ... existing context ...
    "duplicate_members": duplicate_members,  # Add this
}
```

**Step 3: Update Template (`members/templates/members/add_member.html`)**

**Location:** Confirmation step section

**Add warning banner if duplicates found:**
```html
{% if duplicate_members %}
<div class="alert alert-warning" role="alert">
    <h5><i class="bi bi-exclamation-triangle me-2"></i>Potential Duplicate Member Found</h5>
    <p>The following existing member(s) match the information provided:</p>
    <ul>
        {% for match in duplicate_members %}
        <li>
            <strong>{{ match.member.full_name }}</strong> 
            ({{ match.member.member_id|default:"No ID" }}) - 
            Status: {{ match.member.status|title }}
            <br>
            <small class="text-muted">
                Matched by: {{ match.match_reason|title }} 
                ({{ match.match_text }})
            </small>
            <br>
            <a href="{% url 'members:member_detail' match.member.member_uuid %}" 
               class="btn btn-sm btn-outline-primary mt-1" 
               target="_blank">
                View Member
            </a>
        </li>
        {% endfor %}
    </ul>
    <p class="mb-0">
        <strong>Consider reactivating this member instead of creating a new one.</strong>
    </p>
</div>
{% endif %}
```

#### Dependencies

- ✅ Step 5 (Split Views) - Completed
- ✅ MemberService exists - Completed
- ✅ Member model has required fields (first_name, last_name, email, home_phone) - Completed

#### Testing Requirements

1. **Manual Testing:**
   - Create member with name matching existing inactive member
   - Create member with phone matching existing member
   - Create member with email matching existing member
   - Create member with multiple matches (name + phone)
   - Verify warning displays correctly
   - Verify link to existing member works
   - Verify member creation still works (warning doesn't block)

2. **Edge Cases:**
   - Empty phone/email fields
   - Case sensitivity (name matching)
   - Multiple matches for same member (name + phone + email)
   - Active vs inactive members

3. **Automated Testing:**
   - Add test cases to `tests/test_member_service.py` for `check_duplicate_members()`
   - Test name matching (case-insensitive)
   - Test phone matching
   - Test email matching
   - Test combination matches
   - Test empty fields

#### Benefits

- ✅ Prevents duplicate member creation
- ✅ Helps identify inactive members for reactivation
- ✅ Improves data quality
- ✅ Reduces manual cleanup needed
- ✅ Better user experience (suggests reactivation)

#### Implementation Summary

**Completed Steps:**
1. ✅ Added `check_duplicate_members()` static method to `MemberService` class
2. ✅ Updated `add_member_view()` to call duplicate check in "confirm" step
3. ✅ Updated `add_member.html` template to display warning banner when duplicates found
4. ✅ Added comprehensive test suite (9 test cases, all passing)

**Key Changes:**
- `members/services.py`: Added `check_duplicate_members()` method with name, phone, and email matching
- `members/views/members.py`: Added duplicate check call and included results in context
- `members/templates/members/add_member.html`: Added warning banner with matching member details and links
- `tests/test_member_service.py`: Added `TestMemberServiceCheckDuplicateMembers` class with 9 test methods

**Features Implemented:**
- Name matching: Case-insensitive first + last name combination
- Phone matching: Exact match on `home_phone` field (if provided)
- Email matching: Case-insensitive email matching (if provided)
- Duplicate prevention: Avoids duplicate entries in results (checks by `member.pk`)
- Warning display: Shows matching members with full details, status, and view links
- All statuses: Checks active, inactive, and deceased members
- Non-blocking: Warning only, does not prevent member creation

**Testing:**
- ✅ All 9 unit tests passing
- ✅ Manual testing confirmed by user
- ✅ Edge cases tested (empty fields, multiple matches, case sensitivity, all statuses)

#### Notes

- Warning only - does not block member creation (allows override)
- Checks all member statuses (active, inactive, deceased)
- Case-insensitive matching for names and emails
- Phone matching is exact (database field is `home_phone`)
- Future enhancement: Add "Reactivate Instead" button that redirects to reactivation flow

---

## Template for New Changes

### Change #XXX: [Title]

**Status:** Planned  
**Priority:** [High/Medium/Low]  
**Estimated Effort:** [Time estimate]  
**Created:** [Date]

#### Description
[What needs to be changed and why]

#### Current Implementation
[How it currently works]

#### Proposed Implementation
[How it should work]

#### Implementation Steps
1. Step 1: [Description]
2. Step 2: [Description]
3. Step 3: [Description]

#### Dependencies
- [What needs to be completed first]

#### Testing Requirements
- [How to verify it works]

#### Benefits
- [Why this change is valuable]

#### Notes
[Any additional considerations]

---

